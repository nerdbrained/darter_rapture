#### Pipeline for aligning WGS data to reference genome, extracting coverage data, and performing ANGSD/PCAngsd analyses
#### Many of these scripts are taken or modified from Ryan Peek's GitHub (https://ryanpeek.github.io)

#### make list of all sequence files
ls *R1* | sed "s/\.fq//g" > bamlist1
ls *R2* | sed "s/\.fq//g" > bamlist2
paste bamlist? > bamlist

#### Index reference genome

samtools index <reference.fasta>

#### Alignment script for aligning in parallel on a SLURM systen (run_WGAalign.sh):

#!/bin/bash -l
list=$1
ref=$2
wc=$(wc -l ${list} | awk '{print $1}')
x=1
while [ $x -le $wc ] 
do
	string="sed -n ${x}p ${list}" 
	str=$($string)
 	var=$(echo $str | awk -F"\t" '{print $1, $2}')   
	set -- $var
	c1=$1
	c2=$2
	c3=$(echo $c1 | awk -F'_' '{print $1}')
 	echo "#!/bin/bash -l
 	#SBATCH -o slurm_outs/01a_align_flt-%j.out
	#SBATCH -J alignflt
	module load OpenMPI/2.1.1
	module load GCC/6.4.0-2.28
	module load SAMtools
	module load BWA/0.7.17
 	bwa mem $ref ${c1} ${c2} > ${c3}.aln-pe.sam
	samtools view -Sb -o ${c3}.aln-pe.bam ${c3}.aln-pe.sam
	samtools sort -n -o ${c3}.sort.bam ${c3}.aln-pe.bam
	samtools view -f 0x2 -b ${c3}.sort.bam > ${c3}.sort.filt.bam
	samtools fixmate -m ${c3}.sort.filt.bam ${c3}.fixmate.bam
	samtools sort -o ${c3}.positionsort.bam ${c3}.fixmate.bam
	samtools markdup -r ${c3}.positionsort.bam ${c3}.rmdup.bam" > ${c3}.sh 
	sbatch -t 10:00:00 -p med --mem=4G ${c3}.sh
	sleep 2
	x=$(( $x + 1 ))
done


#### Save alignment script and run: sh run_WGAalign.sh bamlist <reference.fasta>

#### If you need to merge data from multiple runs:
#### Need two folders of .bam files with identical names and a folder for merged files

ls <folder1>/*.bam > mergelist
mkdir mergebams

#### Alignment script for merging in parallel on a SLURM systen (merge.sh) - insert your own folder names:

#!/bin/bash -l
list=$1
wc=$(wc -l ${list} | awk '{print $1}')
x=1
while [ $x -le $wc ] 
do
	string="sed -n ${x}p ${list}" 
	str=$($string)
 	echo "#!/bin/bash -l
 	#SBATCH -o slurm_outs/merge-%j.out
	#SBATCH -J merge
	module load OpenMPI/2.1.1
	module load GCC/6.4.0-2.28
	module load SAMtools
 	samtools merge mergebams/${str} <foler1>/${str} <folder2>/${str} > ${str}.sh 
	sbatch -t 3:00:00 -p med --mem=4G ${str}.sh
	sleep 2
	x=$(( $x + 1 ))
done

#### Save merge script and run: sh merge.sh mergelist

#### Calculate coverage and write to a file called "covout" - insert names for each individual: 

echo "<name>" >> covout
samtools depth <name>.rmdup.bam |  awk '{sum+=$3} END { print "Average (covered sites) = ",sum/NR}' >> covout
samtools depth -a <name>.rmdup.bam |  awk '{sum+=$3} END { print "Average (whole genome) = ",sum/NR}' >> covout

#### calculate genotype likelihoods with list of filtered files <EcrWGSbamlist> in ANGSD

angsd -b Ecrbamlist -GL 2 -doGlf 2 -doMajorMinor 1 -SNP_pval 1e-6 -doMaf 1 -nThreads 10 -out angsdgl_EcrWGS

#### calling genotypes with PCAngsd
python pcangsd.py -beagle angsdgl_EcrWGS.beagle.gz -geno 0.9 -o arkgenosRaptEcr -threads 10

#### Estimate covariance matrix and individual admixture proportions
python pcangsd.py -beagle angsdgl_EcrWGS.beagle.gz -admix -o ECr_Adalign_admix -threads 10

##### Estimate covariance matrix and perform selection scan
python pcangsd.py -beagle angsdgl_EcrWGS.beagle.gz -selection 1 -o ECr_Adalign_sel -threads 10
